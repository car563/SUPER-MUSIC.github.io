import React, { useState, useEffect, useRef } from 'react';
import { 
  Search, 
  Play, 
  X, 
  Music, 
  Video, 
  Calendar, 
  Mic2, 
  Clock, 
  Filter, 
  ExternalLink,
  Zap,
  Radio,
  Disc,
  User,
  Film,
  Cpu,
  Wifi,
  Server,
  RefreshCw,
  Globe
} from 'lucide-react';

const App = () => {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);
  const [selectedVideo, setSelectedVideo] = useState(null);
  const [activeTab, setActiveTab] = useState('musicVideo'); // musicVideo or concert
  const [searchMode, setSearchMode] = useState('all'); // 'all' or 'artist'
  const [yearFilter, setYearFilter] = useState('');
  const [sortBy, setSortBy] = useState('relevance'); // relevance, new, old
  const [error, setError] = useState(null);

  // Search function using MusicBrainz API
  const searchMusic = async (searchQuery, overrideMode = null) => {
    if (!searchQuery) return;
    
    setLoading(true);
    setError(null);
    setResults([]);

    const mode = overrideMode || searchMode;

    try {
      // Construct query for MusicBrainz
      let baseQuery = searchQuery;
      
      // If in artist mode, strict search on the artist field
      if (mode === 'artist') {
        baseQuery = `artist:"${searchQuery}"`;
      }

      let mbQuery = baseQuery;

      if (activeTab === 'concert') {
        mbQuery += ' AND type:live';
      } else {
        // Boost relevance for official releases
        mbQuery += ' AND (primarytype:Album OR primarytype:Single)'; 
      }

      const response = await fetch(
        `https://musicbrainz.org/ws/2/release-group?query=${encodeURIComponent(mbQuery)}&fmt=json&limit=50`
      );

      if (!response.ok) {
        if (response.status === 503) throw new Error('Service busy, please try again momentarily.');
        throw new Error('Network response was not ok');
      }

      const data = await response.json();
      
      // Map MusicBrainz structure to our app's structure
      const mappedResults = (data['release-groups'] || []).map(item => ({
        id: item.id,
        title: item.title,
        artist: item['artist-credit']?.[0]?.name || 'Unknown Artist',
        date: item['first-release-date'] || '',
        type: item['primary-type'] || 'Release',
        // We construct the image URL here, but it might 404, so we handle that in the Image component
        image: `https://coverartarchive.org/release-group/${item.id}/front-500`,
        score: item.score
      }));

      setResults(mappedResults);
    } catch (err) {
      console.error(err);
      setError('Could not fetch results from MusicBrainz. The archive might be busy.');
    } finally {
      setLoading(false);
    }
  };

  // Initial Load - Feature Nirvana
  useEffect(() => {
    setQuery('Nirvana');
    setSearchMode('artist');
    searchMusic('Nirvana', 'artist');
  }, []);

  // Handle Search Submit
  const handleSearch = (e) => {
    e.preventDefault();
    searchMusic(query);
  };

  // Handle clicking an artist name to quick-search them
  const handleArtistClick = (artistName, e) => {
    e.stopPropagation(); // Prevent opening the video modal
    setQuery(artistName);
    setSearchMode('artist');
    setResults([]); // Clear current results to show transition
    searchMusic(artistName, 'artist');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // Filter and Sort Logic
  const getProcessedResults = () => {
    let processed = [...results];

    // Filter by Year
    if (yearFilter) {
      processed = processed.filter(item => {
        if (!item.date) return false;
        const year = item.date.split('-')[0];
        return year.startsWith(yearFilter.substring(0, 3)); // simple decade check
      });
    }

    // Sort
    if (sortBy === 'new') {
      processed.sort((a, b) => {
        const dateA = a.date || '0000';
        const dateB = b.date || '0000';
        return dateB.localeCompare(dateA);
      });
    } else if (sortBy === 'old') {
      processed.sort((a, b) => {
        const dateA = a.date || '0000';
        const dateB = b.date || '0000';
        return dateA.localeCompare(dateB);
      });
    }

    return processed;
  };

  return (
    <div className="min-h-screen bg-neutral-950 text-white font-sans selection:bg-rose-500 selection:text-white">
      {/* Navbar */}
      <nav className="sticky top-0 z-40 backdrop-blur-xl bg-neutral-950/80 border-b border-white/10">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-20">
            <div className="flex items-center gap-3 group cursor-pointer" onClick={() => window.location.reload()}>
              <div className="bg-gradient-to-tr from-rose-600 to-orange-600 p-2 rounded-lg group-hover:scale-105 transition-transform">
                <Radio className="w-6 h-6 text-white" />
              </div>
              <span className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-neutral-400 tracking-tight">
                Concert<span className="text-rose-500">Vault</span>
              </span>
            </div>
            
            <div className="hidden md:flex items-center space-x-8 text-sm font-medium text-neutral-400">
              <button 
                onClick={() => { setActiveTab('musicVideo'); setQuery(''); setResults([]); }}
                className={`transition-colors hover:text-white ${activeTab === 'musicVideo' ? 'text-white' : ''}`}
              >
                Music Videos
              </button>
              <button 
                onClick={() => { setActiveTab('concert'); setQuery(''); setResults([]); }}
                className={`transition-colors hover:text-white ${activeTab === 'concert' ? 'text-white' : ''}`}
              >
                Live Concerts
              </button>
            </div>
          </div>
        </div>
      </nav>

      {/* Hero / Search Section */}
      <div className="relative pt-12 pb-16 sm:pt-20 sm:pb-24 overflow-hidden">
        {/* Abstract Background Blobs */}
        <div className="absolute top-0 left-1/4 w-96 h-96 bg-rose-600/20 rounded-full blur-3xl -translate-y-1/2 pointer-events-none"></div>
        <div className="absolute bottom-0 right-1/4 w-96 h-96 bg-orange-600/10 rounded-full blur-3xl translate-y-1/2 pointer-events-none"></div>

        <div className="max-w-4xl mx-auto px-4 relative z-10 text-center">
          <h1 className="text-4xl sm:text-6xl font-extrabold tracking-tight mb-6">
            <span className="block text-neutral-400 mb-2 text-lg sm:text-2xl font-normal tracking-normal uppercase">
              {activeTab === 'musicVideo' ? 'The Visual Archive' : 'The Live Experience'}
            </span>
            Watch {activeTab === 'musicVideo' ? 'Music Videos' : 'Concerts'} <br />
            <span className="bg-clip-text text-transparent bg-gradient-to-r from-rose-500 via-orange-500 to-amber-500">
              Powered by Open Data
            </span>
          </h1>

          <form onSubmit={handleSearch} className="relative max-w-2xl mx-auto group">
            <div className="absolute -inset-1 bg-gradient-to-r from-rose-600 to-orange-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
            
            {/* Search Input Container */}
            <div className="relative flex items-center bg-neutral-900 border border-white/10 rounded-xl overflow-hidden shadow-2xl">
              {/* Search Mode Toggle (Left side of input) */}
              <div className="pl-2 border-r border-white/10 mr-1">
                <button
                  type="button"
                  onClick={() => setSearchMode(prev => prev === 'all' ? 'artist' : 'all')}
                  className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-neutral-400 hover:text-white transition-colors focus:outline-none"
                  title="Toggle Search Mode"
                >
                  {searchMode === 'artist' ? (
                    <>
                      <User className="w-4 h-4 text-rose-500" />
                      <span>Artist</span>
                    </>
                  ) : (
                    <>
                      <Search className="w-4 h-4" />
                      <span>All</span>
                    </>
                  )}
                </button>
              </div>

              <input 
                type="text" 
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder={searchMode === 'artist' ? "Type an artist name..." : `Search ${activeTab === 'musicVideo' ? 'tracks...' : 'concerts...'}`}
                className="w-full bg-transparent px-4 py-5 text-lg placeholder-neutral-500 focus:outline-none text-white"
              />
              <button 
                type="submit"
                className="mr-2 px-6 py-2.5 bg-white text-neutral-950 font-bold rounded-lg hover:bg-neutral-200 transition-colors"
              >
                Search
              </button>
            </div>
          </form>

          {/* Quick Filters */}
          <div className="mt-8 flex flex-wrap justify-center gap-3">
            {['1980', '1990', '2000', '2010', '2020'].map(year => (
              <button 
                key={year}
                onClick={() => { 
                  setYearFilter(year); 
                  if (results.length === 0) {
                    setQuery(`Best of ${year}`);
                    setSearchMode('all');
                    searchMusic(`Best of ${year}`, 'all'); 
                  }
                }}
                className={`px-4 py-1.5 rounded-full border text-sm font-medium transition-all ${
                  yearFilter === year 
                    ? 'bg-rose-600 border-rose-600 text-white' 
                    : 'border-white/10 text-neutral-400 hover:border-white/30 hover:text-white'
                }`}
              >
                {year}s
              </button>
            ))}
            {yearFilter && (
               <button 
               onClick={() => setYearFilter('')}
               className="px-4 py-1.5 rounded-full border border-red-500/30 text-red-400 hover:bg-red-500/10 text-sm flex items-center gap-1"
             >
               <X className="w-3 h-3" /> Clear Year
             </button>
            )}
          </div>

          {/* Legends / Quick Links */}
          <div className="mt-6 flex flex-wrap justify-center gap-4 items-center animate-in fade-in slide-in-from-bottom-4 duration-700 delay-150">
            <span className="text-neutral-500 text-sm font-medium">Legends:</span>
            {['Nirvana', 'Linkin Park', 'Queen', 'Foo Fighters', 'Radiohead', 'Red Hot Chili Peppers'].map(artist => (
              <button
                key={artist}
                onClick={(e) => handleArtistClick(artist, e)}
                className={`text-sm transition-colors border-b border-transparent ${
                   query === artist 
                   ? 'text-rose-400 border-rose-400 font-bold' 
                   : 'text-neutral-400 hover:text-white hover:border-white/50'
                }`}
              >
                {artist}
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Results Section */}
      <div className="max-w-7xl mx-auto px-4 pb-20">
        {/* Controls */}
        {results.length > 0 && (
          <div className="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-8 pb-4 border-b border-white/10 gap-4">
            <div className="text-neutral-400">
              Found <span className="text-white font-bold">{getProcessedResults().length}</span> results for "<span className="text-white">{query}</span>" via MusicBrainz
            </div>
            <div className="flex items-center gap-3">
              <Filter className="w-4 h-4 text-neutral-500" />
              <select 
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value)}
                className="bg-neutral-900 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-neutral-300 focus:outline-none focus:border-white/30"
              >
                <option value="relevance">Relevance</option>
                <option value="new">Newest First</option>
                <option value="old">Oldest First</option>
              </select>
            </div>
          </div>
        )}

        {/* Loading State */}
        {loading && (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 animate-pulse">
            {[...Array(8)].map((_, i) => (
              <div key={i} className="bg-neutral-900 aspect-video rounded-xl border border-white/5"></div>
            ))}
          </div>
        )}

        {/* Error State */}
        {error && (
          <div className="text-center py-20 bg-neutral-900/50 rounded-2xl border border-white/5">
            <Zap className="w-12 h-12 text-rose-500 mx-auto mb-4" />
            <h3 className="text-xl font-bold mb-2">Search Error</h3>
            <p className="text-neutral-400">{error}</p>
          </div>
        )}

        {/* Grid */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {getProcessedResults().map((item) => (
            <div 
              key={item.id} 
              className="group relative bg-neutral-900 rounded-xl overflow-hidden border border-white/5 hover:border-white/20 transition-all duration-300 hover:-translate-y-1 hover:shadow-2xl hover:shadow-rose-500/10 cursor-pointer flex flex-col h-full"
              onClick={() => setSelectedVideo(item)}
            >
              <div className="aspect-square overflow-hidden relative bg-neutral-800">
                <MusicBrainzImage 
                   src={item.image} 
                   alt={item.title} 
                   artist={item.artist}
                />
                
                <div className="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100 backdrop-blur-[2px]">
                   <div className="w-14 h-14 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center border border-white/20 shadow-lg transform scale-50 group-hover:scale-100 transition-all duration-300">
                     <Play className="w-6 h-6 text-white ml-1" fill="currentColor" />
                   </div>
                </div>
              </div>
              
              <div className="p-4 flex flex-col flex-grow">
                <div className="flex items-start justify-between gap-2 mb-2">
                  <h3 className="font-bold text-white line-clamp-2 leading-tight">
                    {item.title}
                  </h3>
                </div>
                {/* Artist Name - Now Clickable */}
                <p 
                  className="group/artist inline-flex items-center gap-1.5 text-neutral-400 text-sm mb-3 hover:text-rose-400 transition-colors z-10 relative"
                  onClick={(e) => handleArtistClick(item.artist, e)}
                  title={`Look up ${item.artist}`}
                >
                   <Mic2 className="w-3.5 h-3.5" />
                   <span className="border-b border-transparent group-hover/artist:border-rose-400/50">{item.artist}</span>
                </p>
                
                <div className="mt-auto flex items-center gap-4 text-xs text-neutral-500 font-medium">
                  {item.date && (
                    <span className="flex items-center gap-1 bg-white/5 px-2 py-1 rounded">
                      <Calendar className="w-3 h-3" />
                      {item.date.split('-')[0]}
                    </span>
                  )}
                  <span className="flex items-center gap-1 uppercase tracking-wider">
                    {item.type}
                  </span>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Empty State */}
        {!loading && results.length === 0 && !error && (
          <div className="text-center py-20">
            <div className="inline-flex items-center justify-center w-20 h-20 rounded-full bg-neutral-900 mb-6 border border-white/10">
              <Disc className="w-10 h-10 text-neutral-600" />
            </div>
            <h3 className="text-2xl font-bold text-white mb-2">Explore the Archive</h3>
            <p className="text-neutral-400 max-w-md mx-auto">
              Search the MusicBrainz open database to find videos and concerts. <br/>
              Use the <span className="text-rose-400 font-bold">Artist</span> toggle for specific band lookups.
            </p>
          </div>
        )}
      </div>

      {/* Video Modal */}
      {selectedVideo && (
        <VideoPlayerModal 
          video={selectedVideo} 
          onClose={() => setSelectedVideo(null)} 
          type={activeTab}
          onArtistClick={handleArtistClick}
        />
      )}

      {/* Footer */}
      <footer className="border-t border-white/10 bg-neutral-950 py-12">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <p className="text-neutral-500 text-sm">
            Metadata provided by MusicBrainz & Cover Art Archive. <br className="sm:hidden"/> 
            Concert Vault Â© {new Date().getFullYear()}
          </p>
        </div>
      </footer>
    </div>
  );
};

// Component to handle MusicBrainz/CoverArtArchive images which often 404
const MusicBrainzImage = ({ src, alt, artist }) => {
  const [imgSrc, setImgSrc] = useState(src);
  const [hasError, setHasError] = useState(false);

  // Generate a consistent gradient based on the artist name
  const getGradient = (name) => {
    const colors = [
      'from-pink-500 to-rose-500',
      'from-purple-500 to-indigo-500', 
      'from-blue-500 to-cyan-500',
      'from-emerald-500 to-teal-500',
      'from-orange-500 to-amber-500'
    ];
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    return colors[Math.abs(hash) % colors.length];
  };

  return hasError ? (
    <div className={`w-full h-full bg-gradient-to-br ${getGradient(artist)} flex items-center justify-center p-4 text-center`}>
      <div className="bg-black/20 p-3 rounded-full backdrop-blur-sm">
        <Music className="w-8 h-8 text-white/80" />
      </div>
    </div>
  ) : (
    <img 
      src={imgSrc} 
      alt={alt}
      className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
      onError={() => setHasError(true)}
    />
  );
};

// Enhanced Video Player that tries to act as a direct proxy with strict fallback
const VideoPlayerModal = ({ video, onClose, type, onArtistClick }) => {
  const [streamUrl, setStreamUrl] = useState(null);
  const [status, setStatus] = useState('initializing'); // initializing, searching, extracting, playing, error, fallback_embed, fallback_standard
  const [errorMsg, setErrorMsg] = useState(null);
  const [proxyNode, setProxyNode] = useState('Auto-Detect');
  const [foundId, setFoundId] = useState(null);
  
  // Refreshed Proxy List
  const PROXY_NODES = [
    'https://pipedapi.kavin.rocks',
    'https://api.piped.projectsegfau.lt',
    'https://pipedapi.moomoo.me',
    'https://api.piped.privacy.com.de',
    'https://pipedapi.smnz.de'
  ];

  const handleRetry = () => {
     setStatus('initializing');
     resolveStream();
  };

  const useStandardPlayer = () => {
    setStatus('fallback_standard');
    // We construct a youtube search embed url as final fallback
    const searchQuery = type === 'concert' 
      ? `${video.artist} ${video.title} full concert live`
      : `${video.artist} ${video.title} official video`;
    setStreamUrl(`https://www.youtube.com/embed?listType=search&list=${encodeURIComponent(searchQuery)}&autoplay=1`);
  };

  const resolveStream = async () => {
    setStatus('searching');
    setStreamUrl(null);
    setErrorMsg(null);
    
    const searchQuery = type === 'concert' 
      ? `${video.artist} ${video.title} full concert live`
      : `${video.artist} ${video.title} official video`;

    let id = null;
    let workingApi = null;

    // 1. Find the ID using Round-Robin on Proxy Nodes
    for (const api of PROXY_NODES) {
      if (id) break;
      try {
        setProxyNode(new URL(api).hostname);
        const response = await fetch(`${api}/search?q=${encodeURIComponent(searchQuery)}&filter=videos`);
        if (response.ok) {
          const data = await response.json();
          if (data.items && data.items.length > 0) {
            // Extract ID from /watch?v=ID
            const urlParts = data.items[0].url.split('v=');
            if (urlParts.length > 1) {
              id = urlParts[1];
              workingApi = api;
            }
          }
        }
      } catch (e) {
        console.log(`Node ${api} failed, switching...`);
      }
    }

    if (!id) {
        console.warn('All proxy nodes failed to find ID. Switching to Standard Player.');
        useStandardPlayer();
        return;
    }
    
    setFoundId(id);

    // 2. Extract RAW Stream URL
    setStatus('extracting');
    
    try {
      const streamResponse = await fetch(`${workingApi}/streams/${id}`);
      if (!streamResponse.ok) throw new Error('Stream fetch failed');
      
      const streamData = await streamResponse.json();
      
      // Find a combined (video+audio) stream, preferably mp4
      const combinedStreams = streamData.videoStreams.filter(s => !s.videoOnly && s.format === 'MPEG-4');
      
      // Sort by quality (highest first)
      combinedStreams.sort((a, b) => {
        const qA = parseInt(a.quality) || 0;
        const qB = parseInt(b.quality) || 0;
        return qB - qA;
      });

      if (combinedStreams.length > 0) {
        setStreamUrl(combinedStreams[0].url);
        setStatus('playing');
      } else {
        throw new Error('No combined stream available');
      }

    } catch (err) {
      console.warn("Direct stream extraction failed, falling back to proxy embed:", err);
      // Fallback to Piped Embed
      setStreamUrl(`https://piped.video/embed/${id}?autoplay=1`);
      setStatus('fallback_embed'); 
    }
  };

  useEffect(() => {
    let isMounted = true;
    if (isMounted) resolveStream();
    return () => { isMounted = false; };
  }, [video, type]);

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-neutral-900 w-full max-w-5xl rounded-2xl overflow-hidden shadow-2xl border border-white/10 flex flex-col max-h-[90vh]">
        {/* Header */}
        <div className="p-4 border-b border-white/10 flex items-center justify-between bg-neutral-900">
          <div>
            <h2 className="text-lg font-bold text-white line-clamp-1">
              {video.title}
            </h2>
            <button 
              onClick={(e) => { onClose(); onArtistClick(video.artist, e); }}
              className="text-sm text-neutral-400 hover:text-rose-400 transition-colors"
            >
              {video.artist}
            </button>
          </div>
          <button 
            onClick={onClose}
            className="p-2 hover:bg-white/10 rounded-full transition-colors"
          >
            <X className="w-6 h-6 text-white" />
          </button>
        </div>

        {/* Player Container */}
        <div className="relative w-full aspect-video bg-black group flex items-center justify-center">
          
          {/* Status Overlay */}
          {(status === 'searching' || status === 'extracting') && (
            <div className="absolute inset-0 flex flex-col items-center justify-center bg-neutral-900 z-10">
               <div className="relative w-16 h-16 mb-6">
                 <div className="absolute inset-0 border-4 border-neutral-700 rounded-full"></div>
                 <div className="absolute inset-0 border-4 border-t-rose-500 rounded-full animate-spin"></div>
                 <Server className="absolute inset-0 m-auto text-neutral-500 w-6 h-6 animate-pulse" />
               </div>
               <p className="text-rose-500 font-bold mb-1">
                 {status === 'searching' ? 'Scanning Proxy Nodes...' : 'Extracting Raw Stream...'}
               </p>
               <p className="text-neutral-500 text-xs font-mono">
                 Node: {proxyNode}
               </p>
            </div>
          )}

          {/* Error State - Rare now due to auto-fallback */}
          {status === 'error' && (
            <div className="text-center p-6">
               <Zap className="w-12 h-12 text-red-500 mx-auto mb-4" />
               <p className="text-white font-bold mb-2">Proxy Connection Failed</p>
               <p className="text-neutral-400 text-sm mb-4">{errorMsg}</p>
               <div className="flex gap-2 justify-center">
                 <button 
                   onClick={handleRetry} 
                   className="flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm"
                 >
                   <RefreshCw className="w-4 h-4" />
                   Retry
                 </button>
                 <button 
                   onClick={useStandardPlayer} 
                   className="flex items-center gap-2 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg text-sm"
                 >
                   <Globe className="w-4 h-4" />
                   Use Standard Player
                 </button>
               </div>
            </div>
          )}

          {/* Native Player (Actual Proxy) */}
          {status === 'playing' && streamUrl && (
            <video 
              src={streamUrl}
              className="w-full h-full focus:outline-none"
              controls
              autoPlay
              playsInline
              onError={() => {
                 console.warn("Video tag failed to load source. Falling back to embed.");
                 setStreamUrl(`https://piped.video/embed/${foundId}?autoplay=1`);
                 setStatus('fallback_embed');
              }}
            >
              Your browser does not support the video tag.
            </video>
          )}

          {/* Fallback Embed (If Raw Stream fails but ID found) */}
          {status === 'fallback_embed' && streamUrl && (
             <iframe 
             src={streamUrl}
             title="Piped Proxy Player"
             className="w-full h-full"
             allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
             allowFullScreen
             onError={() => useStandardPlayer()} // Final fallback
           ></iframe>
          )}

           {/* Standard YouTube Fallback (If Proxy system fails entirely) */}
           {status === 'fallback_standard' && streamUrl && (
             <iframe 
             src={streamUrl}
             title="Standard Player"
             className="w-full h-full"
             allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
             allowFullScreen
           ></iframe>
          )}
        </div>

        {/* Info */}
        <div className="p-6 bg-neutral-900 overflow-y-auto">
          <div className="flex flex-col sm:flex-row gap-6 items-start">
             <div className="w-24 h-24 rounded-lg overflow-hidden flex-shrink-0 shadow-lg hidden sm:block">
               <MusicBrainzImage src={video.image} alt={video.title} artist={video.artist} />
             </div>
             
             <div className="flex-1">
               <div className="flex items-center gap-2 mb-2">
                 <span className={`px-2 py-0.5 rounded text-white text-xs font-bold uppercase tracking-wider flex items-center gap-1 
                   ${status === 'playing' ? 'bg-emerald-600' : 
                     status === 'fallback_standard' ? 'bg-neutral-600' : 'bg-amber-600'}`}>
                   {status === 'playing' ? <Wifi className="w-3 h-3" /> : 
                    status === 'fallback_standard' ? <Globe className="w-3 h-3" /> : <Cpu className="w-3 h-3" />}
                   
                   {status === 'playing' ? 'Direct Stream' : 
                    status === 'fallback_standard' ? 'Standard Player' : 'Proxy Embed'}
                 </span>
                 <span className="text-neutral-500 text-xs border border-white/10 px-2 py-0.5 rounded">
                   {video.date ? video.date.split('-')[0] : 'Unknown'}
                 </span>
               </div>
               <h3 className="text-xl font-bold text-white mb-2">
                 {video.title}
               </h3>
               <p className="text-neutral-400 text-sm mb-4 leading-relaxed">
                 <span 
                    className="hover:text-white cursor-pointer hover:underline"
                    onClick={(e) => { onClose(); onArtistClick(video.artist, e); }}
                 >
                   {video.artist}
                 </span> 
                 <br/>
                 {status === 'playing' && "Connected to Direct Stream. Viewing raw file via proxy network."}
                 {status === 'fallback_embed' && "Optimized connection established via Piped privacy frontend."}
                 {status === 'fallback_standard' && "Proxy nodes busy. Switched to Standard YouTube Player for reliability."}
               </p>
               
               <div className="flex flex-wrap gap-3">
                  {status !== 'fallback_standard' && (
                    <button 
                      onClick={useStandardPlayer}
                      className="inline-flex items-center gap-2 px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-neutral-300 rounded-lg text-sm font-medium transition-colors border border-white/5"
                    >
                      <Globe className="w-4 h-4" />
                      Switch to Standard Player
                    </button>
                  )}
                  {status === 'playing' && (
                    <a 
                      href={streamUrl} 
                      download 
                      target="_blank"
                      rel="noreferrer"
                      className="inline-flex items-center gap-2 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg text-sm font-medium transition-colors"
                    >
                      <Film className="w-4 h-4" />
                      Download Source
                    </a>
                  )}
               </div>
             </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
