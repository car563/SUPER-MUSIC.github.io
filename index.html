<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.5);
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100 p-4 md:p-8 font-sans">
    <div class="max-w-4xl mx-auto space-y-6">
        
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-3">
                <div class="p-2.5 bg-red-600 rounded-lg shadow-lg">
                    <i data-lucide="youtube" class="text-white w-7 h-7"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight">Video Finder</h1>
            </div>
            <p class="text-slate-500 text-xs hidden sm:block">Fast & Private Search</p>
        </div>

        <!-- Search Bar -->
        <div class="bg-slate-800 border border-slate-700 rounded-2xl p-4 shadow-2xl">
            <form id="searchForm" class="relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="search" class="h-5 w-5 text-slate-500 group-focus-within:text-red-500 transition-colors"></i>
                </div>
                <input
                    id="searchInput"
                    type="text"
                    autocomplete="off"
                    class="block w-full pl-12 pr-24 py-4 bg-slate-900 border border-slate-700 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent text-white placeholder-slate-500 transition-all outline-none"
                    placeholder="Search for videos..."
                >
                <div class="absolute inset-y-0 right-2 flex items-center">
                    <button 
                        type="submit"
                        id="searchButton"
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg text-sm font-semibold transition-all disabled:opacity-50 flex items-center gap-2"
                    >
                        <span id="buttonText">Search</span>
                        <i id="loadingIcon" data-lucide="loader-2" class="w-4 h-4 animate-spin hidden"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- Main Content Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Results List -->
            <div class="lg:col-span-2 space-y-4">
                <div id="statusContainer" class="hidden">
                    <div id="loadingState" class="flex flex-col items-center justify-center py-20 text-slate-500 space-y-3">
                        <i data-lucide="loader-2" class="animate-spin text-red-500 w-10 h-10"></i>
                        <p class="animate-pulse font-medium text-slate-300">Syncing with video servers...</p>
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest">Parallel Multi-Server Fetch</p>
                    </div>

                    <div id="errorState" class="hidden bg-slate-800 border-2 border-dashed border-slate-700 p-8 rounded-2xl text-center">
                        <div class="bg-red-500/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="alert-circle" class="text-red-500 w-8 h-8"></i>
                        </div>
                        <p class="text-slate-200 font-bold text-lg">Servers are busy</p>
                        <p class="text-slate-400 text-sm mt-1 mb-6 max-w-xs mx-auto">
                            The public networks are currently heavy. Try one more time.
                        </p>
                        <button id="retryButton" class="text-sm bg-slate-700 hover:bg-slate-600 px-8 py-3 rounded-xl transition-colors inline-flex items-center justify-center gap-2 font-bold">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> Try Again
                        </button>
                    </div>
                </div>

                <div id="resultsList" class="grid grid-cols-1 gap-4">
                    <!-- Results -->
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <div class="bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden shadow-2xl sticky top-8">
                    <div class="p-4 bg-slate-700/30 border-b border-slate-700 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div id="playerStatusDot" class="w-2 h-2 rounded-full bg-slate-600"></div>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Player</span>
                        </div>
                        <button id="closePlayer" class="text-slate-500 hover:text-white transition-colors hidden">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="playerContainer" class="aspect-video bg-slate-900 flex items-center justify-center relative text-center">
                        <div id="emptyPlayer" class="p-8 space-y-3">
                            <i data-lucide="video" class="text-slate-700 w-8 h-8 mx-auto"></i>
                            <p class="text-xs text-slate-500 font-medium">Select a video to preview</p>
                        </div>
                    </div>
                    
                    <div class="p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Activity Log</h4>
                            <button id="clearHistory" class="text-slate-600 hover:text-red-500 transition-colors">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div id="historyList" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                            <!-- History -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resultsList = document.getElementById('resultsList');
        const statusContainer = document.getElementById('statusContainer');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const playerContainer = document.getElementById('playerContainer');
        const playerStatusDot = document.getElementById('playerStatusDot');
        const closePlayer = document.getElementById('closePlayer');
        const historyList = document.getElementById('historyList');

        let history = JSON.parse(localStorage.getItem('yt_v2_history') || '[]');

        function renderHistory() {
            if (history.length === 0) {
                historyList.innerHTML = `<p class="text-[10px] text-slate-600 italic">History is empty</p>`;
                return;
            }
            historyList.innerHTML = history.slice(0, 5).map(item => `
                <div class="bg-slate-900/40 p-2 rounded-lg text-[11px] border border-slate-700/30 text-slate-400 truncate">
                    ${item.type === 'search' ? 'üîç ' + item.val : 'üé¨ ' + item.val}
                </div>
            `).join('');
            lucide.createIcons();
        }

        function copyToClipboard(link, id) {
            const btn = document.querySelector(`[data-copy-id="${id}"]`);
            navigator.clipboard.writeText(link);
            const oldText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> Copied`;
            btn.classList.replace('bg-slate-700', 'bg-green-600');
            lucide.createIcons();
            setTimeout(() => {
                btn.innerHTML = oldText;
                btn.classList.replace('bg-green-600', 'bg-slate-700');
                lucide.createIcons();
            }, 2000);
        }

        function selectVideo(id, title) {
            playerContainer.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            playerStatusDot.classList.replace('bg-slate-600', 'bg-green-500');
            playerStatusDot.classList.add('animate-pulse');
            closePlayer.classList.remove('hidden');
            
            history.unshift({type: 'video', val: title});
            localStorage.setItem('yt_v2_history', JSON.stringify(history.slice(0, 10)));
            renderHistory();
        }

        async function fetchWithTimeout(url, options, timeout = 6000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(url, { ...options, signal: controller.signal });
            clearTimeout(id);
            return response;
        }

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (!query) return;

            statusContainer.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            resultsList.innerHTML = '';
            searchButton.disabled = true;
            document.getElementById('loadingIcon').classList.remove('hidden');

            history.unshift({type: 'search', val: query});
            renderHistory();

            const instances = [
                'https://pipedapi.kavin.rocks',
                'https://pipedapi.lunar.icu',
                'https://pipedapi.leptons.xyz',
                'https://api.piped.projectsegfau.lt',
                'https://piped-api.garudalinux.org',
                'https://pipedapi.rivo.cc'
            ];

            // Parallel Race Strategy: Try all at once
            const fetchPromises = instances.map(async (base) => {
                try {
                    const res = await fetchWithTimeout(`${base}/search?q=${encodeURIComponent(query)}&filter=videos`);
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    if (!data.items || data.items.length === 0) throw new Error();
                    return data.items.filter(i => i.type === 'stream');
                } catch (err) {
                    throw err;
                }
            });

            try {
                // Wait for the first successful server response
                const videos = await Promise.any(fetchPromises);
                
                resultsList.innerHTML = videos.map(v => {
                    const id = v.url.split('v=')[1];
                    return `
                        <div onclick="selectVideo('${id}', '${v.title.replace(/'/g, "\\'")}')" class="bg-slate-800/50 border border-slate-700/50 rounded-xl overflow-hidden flex hover:border-red-500 transition-all cursor-pointer group">
                            <div class="w-32 sm:w-40 aspect-video bg-black shrink-0 relative">
                                <img src="${v.thumbnail}" class="w-full h-full object-cover">
                                <span class="absolute bottom-1 right-1 bg-black/80 text-[9px] px-1 rounded text-white font-bold">${v.duration || ''}</span>
                            </div>
                            <div class="p-3 flex flex-col justify-between min-w-0 flex-1">
                                <div>
                                    <h3 class="text-sm font-bold truncate group-hover:text-red-400">${v.title}</h3>
                                    <p class="text-[10px] text-slate-500 mt-1">${v.uploaderName}</p>
                                </div>
                                <button onclick="event.stopPropagation(); copyToClipboard('https://youtu.be/${id}', '${id}')" 
                                        data-copy-id="${id}"
                                        class="mt-2 self-start bg-slate-700 hover:bg-slate-600 text-[10px] px-3 py-1 rounded-lg font-bold flex items-center gap-1 transition-colors">
                                    <i data-lucide="copy" class="w-3 h-3"></i> Copy Link
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                statusContainer.classList.add('hidden');
                lucide.createIcons();
            } catch (err) {
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
            } finally {
                searchButton.disabled = false;
                document.getElementById('loadingIcon').classList.add('hidden');
            }
        });

        closePlayer.addEventListener('click', () => {
            playerContainer.innerHTML = `<div id="emptyPlayer" class="p-8 space-y-3"><i data-lucide="video" class="text-slate-700 w-8 h-8 mx-auto"></i><p class="text-xs text-slate-500 font-medium">Select a video to preview</p></div>`;
            playerStatusDot.classList.replace('bg-green-500', 'bg-slate-600');
            playerStatusDot.classList.remove('animate-pulse');
            closePlayer.classList.add('hidden');
            lucide.createIcons();
        });

        document.getElementById('retryButton').onclick = () => searchForm.dispatchEvent(new Event('submit'));
        document.getElementById('clearHistory').onclick = () => { history = []; localStorage.removeItem('yt_v2_history'); renderHistory(); };

        lucide.createIcons();
        renderHistory();
    </script>
</body>
</html>
