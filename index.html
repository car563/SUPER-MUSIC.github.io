<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concert Vault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for a premium feel */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #171717; 
        }
        ::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #444; 
        }
        
        /* Animations */
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-neutral-950 text-white font-sans selection:bg-rose-500 selection:text-white">

    <!-- Navbar -->
    <nav class="sticky top-0 z-40 backdrop-blur-xl bg-neutral-950/80 border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-3 group cursor-pointer" onclick="window.location.reload()">
                    <div class="bg-gradient-to-tr from-rose-600 to-orange-600 p-2 rounded-lg group-hover:scale-105 transition-transform">
                        <i data-lucide="radio" class="w-6 h-6 text-white"></i>
                    </div>
                    <span class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-neutral-400 tracking-tight">
                        Concert<span class="text-rose-500">Vault</span>
                    </span>
                </div>
                
                <div class="hidden md:flex items-center space-x-8 text-sm font-medium text-neutral-400">
                    <button id="tab-musicVideo" class="transition-colors text-white hover:text-white" onclick="switchTab('musicVideo')">
                        Music Videos
                    </button>
                    <button id="tab-concert" class="transition-colors hover:text-white" onclick="switchTab('concert')">
                        Live Concerts
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero / Search Section -->
    <div class="relative pt-12 pb-16 sm:pt-20 sm:pb-24 overflow-hidden">
        <!-- Abstract Background Blobs -->
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-rose-600/20 rounded-full blur-3xl -translate-y-1/2 pointer-events-none"></div>
        <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-orange-600/10 rounded-full blur-3xl translate-y-1/2 pointer-events-none"></div>

        <div class="max-w-4xl mx-auto px-4 relative z-10 text-center">
            <h1 class="text-4xl sm:text-6xl font-extrabold tracking-tight mb-6">
                <span id="hero-subtitle" class="block text-neutral-400 mb-2 text-lg sm:text-2xl font-normal tracking-normal uppercase">
                    The Visual Archive
                </span>
                Watch <span id="hero-title-type">Music Videos</span> <br />
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-rose-500 via-orange-500 to-amber-500">
                    Powered by Open Data
                </span>
            </h1>

            <form id="search-form" class="relative max-w-2xl mx-auto group">
                <div class="absolute -inset-1 bg-gradient-to-r from-rose-600 to-orange-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                
                <div class="relative flex items-center bg-neutral-900 border border-white/10 rounded-xl overflow-hidden shadow-2xl">
                    <!-- Search Mode Toggle -->
                    <div class="pl-2 border-r border-white/10 mr-1">
                        <button type="button" id="search-mode-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-neutral-400 hover:text-white transition-colors focus:outline-none">
                            <i data-lucide="search" class="w-4 h-4"></i>
                            <span>All</span>
                        </button>
                    </div>

                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="Search tracks..."
                        class="w-full bg-transparent px-4 py-5 text-lg placeholder-neutral-500 focus:outline-none text-white"
                    />
                    <button 
                        type="submit"
                        class="mr-2 px-6 py-2.5 bg-white text-neutral-950 font-bold rounded-lg hover:bg-neutral-200 transition-colors"
                    >
                        Search
                    </button>
                </div>
            </form>

            <!-- Quick Filters -->
            <div class="mt-8 flex flex-wrap justify-center gap-3" id="year-filters">
                <!-- Year buttons injected by JS -->
            </div>

            <!-- Legends -->
            <div class="mt-6 flex flex-wrap justify-center gap-4 items-center animate-fade-in">
                <span class="text-neutral-500 text-sm font-medium">Legends:</span>
                <div id="legends-container" class="flex flex-wrap gap-4"></div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="max-w-7xl mx-auto px-4 pb-20">
        <!-- Controls -->
        <div id="results-controls" class="hidden flex flex-col sm:flex-row justify-between items-end sm:items-center mb-8 pb-4 border-b border-white/10 gap-4">
            <div class="text-neutral-400">
                Found <span id="results-count" class="text-white font-bold">0</span> results for "<span id="results-query" class="text-white"></span>" via MusicBrainz
            </div>
            <div class="flex items-center gap-3">
                <i data-lucide="filter" class="w-4 h-4 text-neutral-500"></i>
                <select id="sort-select" class="bg-neutral-900 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-neutral-300 focus:outline-none focus:border-white/30">
                    <option value="relevance">Relevance</option>
                    <option value="new">Newest First</option>
                    <option value="old">Oldest First</option>
                </select>
            </div>
        </div>

        <!-- Content Grid -->
        <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Items injected here -->
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 animate-pulse">
            <div class="bg-neutral-900 aspect-video rounded-xl border border-white/5"></div>
            <div class="bg-neutral-900 aspect-video rounded-xl border border-white/5"></div>
            <div class="bg-neutral-900 aspect-video rounded-xl border border-white/5"></div>
            <div class="bg-neutral-900 aspect-video rounded-xl border border-white/5"></div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-neutral-900 mb-6 border border-white/10">
                <i data-lucide="disc" class="w-10 h-10 text-neutral-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-2">Explore the Archive</h3>
            <p class="text-neutral-400 max-w-md mx-auto">
                Search the MusicBrainz open database to find videos and concerts. <br/>
                Use the <span class="text-rose-400 font-bold">Artist</span> toggle for specific band lookups.
            </p>
        </div>
        
        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-20 bg-neutral-900/50 rounded-2xl border border-white/5">
            <i data-lucide="zap" class="w-12 h-12 text-rose-500 mx-auto mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Search Error</h3>
            <p id="error-message" class="text-neutral-400"></p>
        </div>
    </div>

    <!-- Video Modal -->
    <div id="video-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-fade-in">
        <div class="bg-neutral-900 w-full max-w-5xl rounded-2xl overflow-hidden shadow-2xl border border-white/10 flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-4 border-b border-white/10 flex items-center justify-between bg-neutral-900">
                <div>
                    <h2 id="modal-title" class="text-lg font-bold text-white line-clamp-1">Title</h2>
                    <button id="modal-artist-btn" class="text-sm text-neutral-400 hover:text-rose-400 transition-colors">Artist</button>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-white/10 rounded-full transition-colors">
                    <i data-lucide="x" class="w-6 h-6 text-white"></i>
                </button>
            </div>

            <!-- Player Container -->
            <div class="relative w-full aspect-video bg-black group flex items-center justify-center overflow-hidden" id="player-container">
                <!-- Player injected here -->
            </div>

            <!-- Info -->
            <div class="p-6 bg-neutral-900 overflow-y-auto">
                <div class="flex flex-col sm:flex-row gap-6 items-start">
                    <div class="w-24 h-24 rounded-lg overflow-hidden flex-shrink-0 shadow-lg hidden sm:block" id="modal-art-container">
                        <!-- Art injected here -->
                    </div>
                    
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span id="modal-badge" class="px-2 py-0.5 rounded text-white text-xs font-bold uppercase tracking-wider flex items-center gap-1 bg-neutral-600">
                                Status
                            </span>
                            <span id="modal-date" class="text-neutral-500 text-xs border border-white/10 px-2 py-0.5 rounded">
                                Date
                            </span>
                        </div>
                        <h3 id="modal-main-title" class="text-xl font-bold text-white mb-2">Title</h3>
                        <p id="modal-description" class="text-neutral-400 text-sm mb-4 leading-relaxed">
                            Description...
                        </p>
                        
                        <div class="flex flex-wrap gap-3">
                            <a id="modal-mb-link" href="#" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 text-white border border-white/10 rounded-lg text-sm font-medium transition-colors">
                                <i data-lucide="disc" class="w-4 h-4"></i>
                                View Release Data
                            </a>
                            <button id="modal-standard-btn" class="hidden inline-flex items-center gap-2 px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-neutral-300 rounded-lg text-sm font-medium transition-colors border border-white/5">
                                <i data-lucide="globe" class="w-4 h-4"></i>
                                Switch to Standard Player
                            </button>
                            <a id="modal-download-btn" href="#" target="_blank" class="hidden inline-flex items-center gap-2 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg text-sm font-medium transition-colors">
                                <i data-lucide="film" class="w-4 h-4"></i>
                                Download Source
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-white/10 bg-neutral-950 py-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-neutral-500 text-sm">
                Metadata provided by MusicBrainz & Cover Art Archive. <br class="sm:hidden"/> 
                Concert Vault Â© <span id="current-year"></span>
            </p>
        </div>
    </footer>

    <script>
        // --- State ---
        let state = {
            query: '',
            results: [],
            loading: false,
            selectedVideo: null,
            activeTab: 'musicVideo', // musicVideo or concert
            searchMode: 'all', // 'all' or 'artist'
            yearFilter: '',
            sortBy: 'relevance',
            error: null
        };

        const PROXY_NODES = [
            'https://pipedapi.kavin.rocks',
            'https://api.piped.projectsegfau.lt',
            'https://pipedapi.moomoo.me',
            'https://api.piped.privacy.com.de',
            'https://pipedapi.smnz.de'
        ];

        // --- DOM Elements ---
        const els = {
            tabMusic: document.getElementById('tab-musicVideo'),
            tabConcert: document.getElementById('tab-concert'),
            heroSubtitle: document.getElementById('hero-subtitle'),
            heroTitleType: document.getElementById('hero-title-type'),
            searchForm: document.getElementById('search-form'),
            searchInput: document.getElementById('search-input'),
            searchModeBtn: document.getElementById('search-mode-btn'),
            yearFilters: document.getElementById('year-filters'),
            legendsContainer: document.getElementById('legends-container'),
            resultsControls: document.getElementById('results-controls'),
            resultsCount: document.getElementById('results-count'),
            resultsQuery: document.getElementById('results-query'),
            sortSelect: document.getElementById('sort-select'),
            resultsGrid: document.getElementById('results-grid'),
            loadingState: document.getElementById('loading-state'),
            emptyState: document.getElementById('empty-state'),
            errorState: document.getElementById('error-state'),
            errorMessage: document.getElementById('error-message'),
            videoModal: document.getElementById('video-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalArtistBtn: document.getElementById('modal-artist-btn'),
            playerContainer: document.getElementById('player-container'),
            modalArtContainer: document.getElementById('modal-art-container'),
            modalBadge: document.getElementById('modal-badge'),
            modalDate: document.getElementById('modal-date'),
            modalMainTitle: document.getElementById('modal-main-title'),
            modalDescription: document.getElementById('modal-description'),
            modalMbLink: document.getElementById('modal-mb-link'),
            modalDownloadBtn: document.getElementById('modal-download-btn'),
            modalStandardBtn: document.getElementById('modal-standard-btn'),
            currentYear: document.getElementById('current-year')
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            els.currentYear.textContent = new Date().getFullYear();
            
            // Render Filters
            renderYearFilters();
            renderLegends();
            
            // Initial Search (Nirvana)
            setSearchMode('artist');
            state.query = 'Nirvana';
            els.searchInput.value = 'Nirvana';
            searchMusic('Nirvana', 'artist');

            // Event Listeners
            els.searchForm.addEventListener('submit', handleSearch);
            els.sortSelect.addEventListener('change', (e) => {
                state.sortBy = e.target.value;
                renderResults();
            });
            els.searchModeBtn.addEventListener('click', toggleSearchMode);
            
            // Close modal on click outside
            els.videoModal.addEventListener('click', (e) => {
                if (e.target === els.videoModal) closeModal();
            });
            
            // Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !els.videoModal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        });

        // --- Logic ---

        function switchTab(tab) {
            state.activeTab = tab;
            state.results = [];
            state.query = '';
            els.searchInput.value = '';
            
            // UI Updates
            if (tab === 'musicVideo') {
                els.tabMusic.classList.add('text-white');
                els.tabMusic.classList.remove('text-neutral-400');
                els.tabConcert.classList.remove('text-white');
                els.tabConcert.classList.add('text-neutral-400');
                els.heroSubtitle.textContent = 'The Visual Archive';
                els.heroTitleType.textContent = 'Music Videos';
                els.searchInput.placeholder = state.searchMode === 'artist' ? "Type an artist name..." : "Search tracks...";
            } else {
                els.tabConcert.classList.add('text-white');
                els.tabConcert.classList.remove('text-neutral-400');
                els.tabMusic.classList.remove('text-white');
                els.tabMusic.classList.add('text-neutral-400');
                els.heroSubtitle.textContent = 'The Live Experience';
                els.heroTitleType.textContent = 'Concerts';
                els.searchInput.placeholder = state.searchMode === 'artist' ? "Type an artist name..." : "Search live albums...";
            }
            
            renderResults();
        }

        function toggleSearchMode() {
            setSearchMode(state.searchMode === 'all' ? 'artist' : 'all');
        }

        function setSearchMode(mode) {
            state.searchMode = mode;
            const icon = mode === 'artist' ? 'user' : 'search';
            const text = mode === 'artist' ? 'Artist' : 'All';
            const colorClass = mode === 'artist' ? 'text-rose-500' : 'text-white';
            
            els.searchModeBtn.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${colorClass}"></i><span>${text}</span>`;
            
            // Update placeholder
            const placeholderContext = state.activeTab === 'musicVideo' ? 'tracks...' : 'concerts...';
            els.searchInput.placeholder = mode === 'artist' ? "Type an artist name..." : `Search ${placeholderContext}`;
            
            lucide.createIcons();
        }

        function handleSearch(e) {
            e.preventDefault();
            state.query = els.searchInput.value;
            searchMusic(state.query);
        }

        function handleArtistClick(artistName, e) {
            if(e) e.stopPropagation();
            state.query = artistName;
            els.searchInput.value = artistName;
            setSearchMode('artist');
            state.results = [];
            renderResults(); // clear immediately
            searchMusic(artistName, 'artist');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            closeModal();
        }

        async function searchMusic(searchQuery, overrideMode = null) {
            if (!searchQuery) return;
            
            state.loading = true;
            state.error = null;
            state.results = [];
            renderResults(); // Show loading state via render logic or manually toggle
            els.loadingState.classList.remove('hidden');
            els.emptyState.classList.add('hidden');
            els.resultsGrid.innerHTML = '';
            els.resultsControls.classList.add('hidden');

            const mode = overrideMode || state.searchMode;
            let baseQuery = searchQuery;
            
            if (mode === 'artist') {
                baseQuery = `artist:"${searchQuery}"`;
            }

            let mbQuery = baseQuery;
            if (state.activeTab === 'concert') {
                mbQuery += ' AND type:live';
            } else {
                mbQuery += ' AND (primarytype:Album OR primarytype:Single)'; 
            }

            try {
                const response = await fetch(
                    `https://musicbrainz.org/ws/2/release-group?query=${encodeURIComponent(mbQuery)}&fmt=json&limit=50`
                );

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                state.results = (data['release-groups'] || []).map(item => ({
                    id: item.id,
                    title: item.title,
                    artist: item['artist-credit']?.[0]?.name || 'Unknown Artist',
                    date: item['first-release-date'] || '',
                    type: item['primary-type'] || 'Release',
                    image: `https://coverartarchive.org/release-group/${item.id}/front-500`,
                    score: item.score
                }));

            } catch (err) {
                console.error(err);
                state.error = 'Could not fetch results from MusicBrainz. The archive might be busy.';
            } finally {
                state.loading = false;
                els.loadingState.classList.add('hidden');
                renderResults();
            }
        }

        function renderResults() {
            // Process results (Filter & Sort)
            let processed = [...state.results];

            // Filter by Year
            if (state.yearFilter) {
                processed = processed.filter(item => {
                    if (!item.date) return false;
                    const year = item.date.split('-')[0];
                    return year.startsWith(state.yearFilter.substring(0, 3));
                });
            }

            // Sort
            if (state.sortBy === 'new') {
                processed.sort((a, b) => (b.date || '0000').localeCompare(a.date || '0000'));
            } else if (state.sortBy === 'old') {
                processed.sort((a, b) => (a.date || '0000').localeCompare(b.date || '0000'));
            }

            // Update DOM
            els.resultsGrid.innerHTML = '';
            
            if (state.error) {
                els.errorState.classList.remove('hidden');
                els.errorMessage.textContent = state.error;
                return;
            } else {
                els.errorState.classList.add('hidden');
            }

            if (!state.loading && processed.length === 0) {
                els.emptyState.classList.remove('hidden');
                els.resultsControls.classList.add('hidden');
                return;
            } else {
                els.emptyState.classList.add('hidden');
            }

            if (processed.length > 0) {
                els.resultsControls.classList.remove('hidden');
                els.resultsCount.textContent = processed.length;
                els.resultsQuery.textContent = state.query;
            }

            processed.forEach(item => {
                const card = document.createElement('div');
                card.className = "group relative bg-neutral-900 rounded-xl overflow-hidden border border-white/5 hover:border-white/20 transition-all duration-300 hover:-translate-y-1 hover:shadow-2xl hover:shadow-rose-500/10 cursor-pointer flex flex-col h-full";
                card.onclick = () => openModal(item);

                // Image Handling
                const gradient = getGradient(item.artist);
                const year = item.date ? item.date.split('-')[0] : '';
                
                // Using a simpler image load approach for vanilla JS
                const imgHTML = `
                    <img 
                        src="${item.image}" 
                        alt="${item.title}" 
                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                        onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-full h-full bg-gradient-to-br ${gradient} flex items-center justify-center p-4\\'><div class=\\'bg-black/20 p-3 rounded-full backdrop-blur-sm\\'><i data-lucide=\\'music\\' class=\\'w-8 h-8 text-white/80\\'></i></div></div>'; lucide.createIcons();"
                    />
                `;

                card.innerHTML = `
                    <div class="aspect-square overflow-hidden relative bg-neutral-800">
                        ${imgHTML}
                        <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100 backdrop-blur-[2px]">
                           <div class="w-14 h-14 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center border border-white/20 shadow-lg transform scale-50 group-hover:scale-100 transition-all duration-300">
                             <i data-lucide="play" class="w-6 h-6 text-white ml-1 fill-current"></i>
                           </div>
                        </div>
                    </div>
                    
                    <div class="p-4 flex flex-col flex-grow">
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <h3 class="font-bold text-white line-clamp-2 leading-tight">${item.title}</h3>
                        </div>
                        <p class="group/artist inline-flex items-center gap-1.5 text-neutral-400 text-sm mb-3 hover:text-rose-400 transition-colors z-10 relative w-fit" onclick="handleArtistClick('${item.artist.replace(/'/g, "\\'")}', event)">
                           <i data-lucide="mic-2" class="w-3.5 h-3.5"></i>
                           <span class="border-b border-transparent group-hover/artist:border-rose-400/50">${item.artist}</span>
                        </p>
                        
                        <div class="mt-auto flex items-center gap-4 text-xs text-neutral-500 font-medium">
                             ${year ? `
                                <span class="flex items-center gap-1 bg-white/5 px-2 py-1 rounded">
                                    <i data-lucide="calendar" class="w-3 h-3"></i>
                                    ${year}
                                </span>
                             ` : ''}
                            <span class="flex items-center gap-1 uppercase tracking-wider">
                                ${item.type}
                            </span>
                        </div>
                    </div>
                `;
                els.resultsGrid.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- Filters & Legends Renderers ---
        function renderYearFilters() {
            const years = ['1980', '1990', '2000', '2010', '2020'];
            els.yearFilters.innerHTML = years.map(year => `
                <button 
                    onclick="applyYearFilter('${year}')"
                    class="px-4 py-1.5 rounded-full border text-sm font-medium transition-all ${state.yearFilter === year ? 'bg-rose-600 border-rose-600 text-white' : 'border-white/10 text-neutral-400 hover:border-white/30 hover:text-white'}"
                >
                    ${year}s
                </button>
            `).join('') + (state.yearFilter ? `
               <button 
               onclick="applyYearFilter('')"
               class="px-4 py-1.5 rounded-full border border-red-500/30 text-red-400 hover:bg-red-500/10 text-sm flex items-center gap-1"
             >
               <i data-lucide="x" class="w-3 h-3"></i> Clear Year
             </button>` : '');
             lucide.createIcons();
        }

        function applyYearFilter(year) {
            state.yearFilter = year;
            if (state.results.length === 0 && year) {
                // If empty and clicking a year, trigger a search
                state.query = `Best of ${year}`;
                els.searchInput.value = state.query;
                setSearchMode('all');
                searchMusic(state.query, 'all');
            }
            renderYearFilters();
            renderResults();
        }

        function renderLegends() {
            const artists = ['Nirvana', 'Linkin Park', 'Queen', 'Foo Fighters', 'Radiohead', 'Red Hot Chili Peppers'];
            els.legendsContainer.innerHTML = artists.map(artist => `
                <button
                    onclick="handleArtistClick('${artist}')"
                    class="text-sm transition-colors border-b border-transparent text-neutral-400 hover:text-white hover:border-white/50"
                >
                    ${artist}
                </button>
            `).join('');
        }

        // --- Modal & Player Logic ---

        function openModal(item) {
            state.selectedVideo = item;
            els.videoModal.classList.remove('hidden');
            
            // Populate basic info
            els.modalTitle.textContent = item.title;
            els.modalArtistBtn.textContent = item.artist;
            els.modalArtistBtn.onclick = () => handleArtistClick(item.artist);
            els.modalMainTitle.textContent = item.title;
            els.modalBadge.textContent = "Initializing...";
            els.modalBadge.className = "px-2 py-0.5 rounded text-white text-xs font-bold uppercase tracking-wider flex items-center gap-1 bg-neutral-600";
            els.modalDate.textContent = item.date ? item.date.split('-')[0] : 'Unknown';
            els.modalDescription.innerHTML = `
                <span class="hover:text-white cursor-pointer hover:underline" onclick="handleArtistClick('${item.artist.replace(/'/g, "\\'")}')">${item.artist}</span><br/>
                Initializing stream connection...
            `;
            els.modalMbLink.href = `https://musicbrainz.org/release-group/${item.id}`;
            
            // Image in modal
            const gradient = getGradient(item.artist);
            els.modalArtContainer.innerHTML = `
                <img 
                    src="${item.image}" 
                    class="w-full h-full object-cover"
                    onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-full h-full bg-gradient-to-br ${gradient} flex items-center justify-center p-4\\'><div class=\\'bg-black/20 p-3 rounded-full backdrop-blur-sm\\'><i data-lucide=\\'music\\' class=\\'w-8 h-8 text-white/80\\'></i></div></div>'; lucide.createIcons();"
                />
            `;

            // Reset buttons
            els.modalDownloadBtn.classList.add('hidden');
            els.modalStandardBtn.classList.add('hidden');

            resolveStream(item);
        }

        function closeModal() {
            els.videoModal.classList.add('hidden');
            els.playerContainer.innerHTML = ''; // Stop video
            state.selectedVideo = null;
        }

        async function resolveStream(video) {
            // Reset Player UI
            els.playerContainer.innerHTML = `
                <div class="absolute inset-0 flex flex-col items-center justify-center bg-neutral-900 z-10">
                   <div class="relative w-16 h-16 mb-6">
                     <div class="absolute inset-0 border-4 border-neutral-700 rounded-full"></div>
                     <div class="absolute inset-0 border-4 border-t-rose-500 rounded-full animate-spin"></div>
                     <i data-lucide="server" class="absolute inset-0 m-auto text-neutral-500 w-6 h-6 animate-pulse"></i>
                   </div>
                   <p class="text-rose-500 font-bold mb-1">Scanning Proxy Nodes...</p>
                   <p class="text-neutral-500 text-xs font-mono">Auto-Detect</p>
                </div>
            `;
            lucide.createIcons();

            const searchQuery = state.activeTab === 'concert' 
                ? `${video.artist} ${video.title} full concert live`
                : `${video.artist} ${video.title} official video`;

            let id = null;
            let workingApi = null;

            // 1. Find ID
            for (const api of PROXY_NODES) {
                if (id) break;
                try {
                    const response = await fetch(`${api}/search?q=${encodeURIComponent(searchQuery)}&filter=videos`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.items && data.items.length > 0) {
                            const urlParts = data.items[0].url.split('v=');
                            if (urlParts.length > 1) {
                                id = urlParts[1];
                                workingApi = api;
                            }
                        }
                    }
                } catch (e) { console.log(`Node ${api} failed`); }
            }

            if (!id) {
                useStandardPlayer(searchQuery, "All proxy nodes failed.");
                return;
            }

            // 2. Extract Stream
            els.playerContainer.querySelector('p').textContent = "Extracting Raw Stream...";
            
            try {
                const streamResponse = await fetch(`${workingApi}/streams/${id}`);
                if (!streamResponse.ok) throw new Error('Stream fetch failed');
                const streamData = await streamResponse.json();
                
                const combinedStreams = streamData.videoStreams.filter(s => !s.videoOnly && s.format === 'MPEG-4');
                combinedStreams.sort((a, b) => (parseInt(a.quality) || 0) - (parseInt(b.quality) || 0)).reverse();

                if (combinedStreams.length > 0) {
                    playDirectStream(combinedStreams[0].url, id, video);
                } else {
                    throw new Error('No combined stream');
                }
            } catch (err) {
                console.warn("Direct stream failed, fallback to embed", err);
                playEmbedFallback(id, video);
            }
        }

        function playDirectStream(url, id, video) {
            els.playerContainer.innerHTML = `
                <video 
                    src="${url}"
                    class="w-full h-full focus:outline-none"
                    controls
                    autoplay
                    playsinline
                >
                    Your browser does not support the video tag.
                </video>
            `;
            // Add error listener to video element
            els.playerContainer.querySelector('video').onerror = () => playEmbedFallback(id, video);

            // Update UI Info
            updateModalStatus('playing', "Connected to Direct Stream. Viewing raw file via proxy network.");
            els.modalDownloadBtn.classList.remove('hidden');
            els.modalDownloadBtn.href = url;
            
            els.modalStandardBtn.classList.remove('hidden');
            els.modalStandardBtn.onclick = () => {
                 const searchQuery = state.activeTab === 'concert' 
                ? `${video.artist} ${video.title} full concert live`
                : `${video.artist} ${video.title} official video`;
                useStandardPlayer(searchQuery);
            };
        }

        function playEmbedFallback(id, video) {
            els.playerContainer.innerHTML = `
                <iframe 
                 src="https://piped.video/embed/${id}?autoplay=1"
                 title="Piped Proxy Player"
                 class="w-full h-full"
                 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                 allowFullScreen
               ></iframe>
            `;
            // Ideally we detect iframe error but difficult with cross-origin. 
            // We assume embed works if ID exists.
            
            updateModalStatus('embed', "Optimized connection established via Piped privacy frontend.");
            els.modalStandardBtn.classList.remove('hidden');
            els.modalStandardBtn.onclick = () => {
                 const searchQuery = state.activeTab === 'concert' 
                ? `${video.artist} ${video.title} full concert live`
                : `${video.artist} ${video.title} official video`;
                useStandardPlayer(searchQuery);
            };
        }

        function useStandardPlayer(searchQuery, reason = "") {
            const url = `https://www.youtube.com/embed?listType=search&list=${encodeURIComponent(searchQuery)}&autoplay=1`;
            els.playerContainer.innerHTML = `
                <iframe 
                 src="${url}"
                 title="Standard Player"
                 class="w-full h-full"
                 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                 allowFullScreen
               ></iframe>
            `;
            updateModalStatus('standard', "Switched to Standard YouTube Player for reliability. " + reason);
            els.modalDownloadBtn.classList.add('hidden');
            els.modalStandardBtn.classList.add('hidden');
        }

        function updateModalStatus(status, text) {
            let color = 'bg-neutral-600';
            let icon = 'cpu';
            let label = 'Status';

            if(status === 'playing') {
                color = 'bg-emerald-600';
                icon = 'wifi';
                label = 'Direct Stream';
            } else if (status === 'embed') {
                color = 'bg-amber-600';
                icon = 'cpu';
                label = 'Proxy Embed';
            } else if (status === 'standard') {
                color = 'bg-neutral-600';
                icon = 'globe';
                label = 'Standard Player';
            }

            els.modalBadge.className = `px-2 py-0.5 rounded text-white text-xs font-bold uppercase tracking-wider flex items-center gap-1 ${color}`;
            els.modalBadge.innerHTML = `<i data-lucide="${icon}" class="w-3 h-3"></i> ${label}`;
            
            // Keep artist link part
            const artistPart = `<span class="hover:text-white cursor-pointer hover:underline" onclick="handleArtistClick('${state.selectedVideo.artist.replace(/'/g, "\\'")}', event)">${state.selectedVideo.artist}</span><br/>`;
            els.modalDescription.innerHTML = artistPart + text;
            lucide.createIcons();
        }

        // --- Helpers ---
        function getGradient(name) {
            const colors = [
                'from-pink-500 to-rose-500',
                'from-purple-500 to-indigo-500', 
                'from-blue-500 to-cyan-500',
                'from-emerald-500 to-teal-500',
                'from-orange-500 to-amber-500'
            ];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }

    </script>
</body>
</html>
